好，那我直接帮你做 **①：把整份 TTS 文档“瘦身”为《音频资产策略》版本**。
这是一份**可以直接替换你现有 TTS 技术方案的“上位文档”**，**长期可放入 docs/，而不是 claude.md 主上下文**。

你可以把它当成：

> 👉 **所有工程、前端、后端、AI Agent 对“语音”的唯一正确世界观**

---

# 📄 文档名（建议）

```
docs/audio/audio-asset-strategy.md
```

---

# Moon Pal · 音频资产策略（Audio Asset Strategy）

## 0. 文档目的（必读）

本文件用于**统一 Moon Pal 产品中关于语音（TTS）的技术心智模型**，明确：

- 什么是“音频”
- 什么时候生成
- 什么时候播放
- 哪些事情**绝对不能做**

> **本产品不存在“实时 TTS 服务”概念，所有语音均为“音频资产（Audio Asset）”。**

---

## 1. 核心原则（不可违背）

### 1.1 音频是资产，不是服务

Moon Pal 中的语音 **不是**：

- ❌ 用户点击后即时合成
- ❌ 会话式、流式生成
- ❌ 需要用户等待的服务

而是：

- ✅ 预先或异步生成的 **音频资产**
- ✅ 存储在对象存储/CDN 中
- ✅ 在播放时只做“选择”，不做“生成”

---

### 1.2 播放层与生成层完全解耦

```
时间轴 ─────────────────────────────────────────>

【播放层（用户可感知）】
完成仪式 → 立即播放已有音频资产 ───────────────>

【生成层（用户不可感知）】
                ↑
        后台异步生成 / 更新音频资产
                ↓
            用于未来播放
```

- 播放层 **永不等待生成**
- 生成层 **永不阻塞体验**
- 二者不共享“完成状态”

---

## 2. 音频资产类型定义

### 2.1 通用音频资产（General Audio Asset）

**定义**：
与具体孩子无关，仅与「清醒度 / 能量状态」相关的音频。

**特征**：

- 提前由管理后台生成
- 覆盖全部清醒度档位
- 所有非会员 & 会员兜底使用

示例：

```json
{
  "type": "general",
  "arousal_level": "low",
  "voice": "female_soft",
  "language": "zh-CN"
}
```

---

### 2.2 个性化音频资产（Personalized Audio Asset）

**定义**：
混入孩子姓名、年龄、性别等特征的专属音频。

**特征**：

- 仅会员可用
- 永远异步生成
- 不保证即时可用
- 不影响当前播放

示例：

```json
{
  "type": "personalized",
  "child_id": "xxx",
  "arousal_level": "low",
  "features": ["name", "age", "gender"]
}
```

---

## 3. 播放策略（最重要）

### 3.1 播放时的唯一逻辑

```ts
playAudio(arousalLevel, childId) {
  const audio =
    findPersonalizedAsset(childId, arousalLevel)
    ?? findGeneralAsset(arousalLevel)
    ?? findFallbackAsset();

  play(audio);
}
```

### 3.2 播放阶段 **禁止行为**

- ❌ 播放前调用 TTS
- ❌ 播放中等待生成
- ❌ 因为没有个性化音频而中断
- ❌ 向用户展示“生成中”

---

## 4. 生成策略（后台行为）

### 4.1 允许触发生成的场景

| 场景            | 是否生成 | 是否影响当前播放 |
| --------------- | -------- | ---------------- |
| 成为会员        | ✅       | ❌               |
| Magic Note 更新 | ✅       | ❌               |
| 孩子信息变更    | ✅       | ❌               |
| 播放完成后      | 可选     | ❌               |
| 后台批量任务    | ✅       | ❌               |

> **生成永远发生在“体验之前或之后”，而不是“当下”**

---

### 4.2 推荐生成方式

- 后端队列（BullMQ / Cloud Task）
- 批量 & 延迟友好
- 可失败、可重试、不告知用户

---

## 5. 技术实现边界（为工程服务）

### 5.1 后端职责

- 管理音频资产元数据
- 调度生成任务
- 提供“按条件取可用音频”的接口

### 5.2 前端职责

- 只负责：

  - 请求可播放音频
  - 播放 URL

- **不感知生成状态**
- **不处理 TTS 逻辑**

---

## 6. 绝对禁止事项（⚠️ 强制）

以下行为 **视为架构错误**：

- ❌ WebSocket 推送音频给前端
- ❌ SSE / 流式 TTS
- ❌ 前端轮询生成状态
- ❌ 把“生成成功”作为播放条件
- ❌ 在孩子界面展示任何技术状态

---

## 7. 产品哲学对齐（写给未来的你）

> **Moon Pal 的语音，是“已经在那里的陪伴”，
> 而不是“正在赶来的回应”。**

任何让孩子**等待**、**感知系统在工作**的设计，
都与本产品理念冲突。

---

## 8. 本文档的使用方式（重要）

- ✅ 被 `claude.md` 引用
- ❌ 不全文塞进 claude 主上下文
- ✅ 当涉及 TTS / 音频 / 播放逻辑时，再加载
