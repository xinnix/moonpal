# Moon Pal AI 边界与护栏

**版本**: V1.0
**重要性**: ⭐⭐⭐⭐⭐ (核心约束)
**适用范围**: 所有 LLM 生成内容

---

## 一、AI 能做什么（明确边界）

### 1.1 AI 的职责

AI 在 Moon Pal 中的唯一职责：

> **基于清醒度分桶和 Magic Note，生成符合《叙述内容规则》的陪伴式叙述文本。同时实现文本转语音（tts）**

---

### 1.2 AI 可以生成的

✅ **允许**:

- 描述自然状态的句子（"天空很安静"）
- 描述"在场"的句子（"小熊在旁边"）
- 描述感受的句子（"风轻轻吹过"）
- 描述身体放松的句子（"肩膀可以放松"）

✅ **允许的输入参考**:

- 清醒度 (0.0-1.0) → 映射到分桶
- Magic Note (≤20 字) → 1-2 次提及
- 孩子昵称 → 1 次提及（仅会员）

---

## 二、AI 不能做什么（核心护栏）

### 2.1 严格禁止（硬约束）

❌ **禁止对话**:

- 不生成疑问句
- 不期待回应
- 不引导交互

❌ **禁止分析**:

- 不判断情绪状态
- 不归因行为动机
- 不评价今日经历

❌ **禁止教育**:

- 不传递价值观
- 不说"应该""必须"
- 不暗示因果关系

❌ **禁止情节**:

- 不推进故事线
- 不使用"然后""接着"
- 不制造冲突或解决问题

---

### 2.2 输出边界

| 维度 | 边界       | 说明               |
| ---- | ---------- | ------------------ |
| 句式 | 仅陈述句   | 禁止疑问句、祈使句 |
| 语气 | 温和、平静 | 禁止激动、夸张     |
| 词汇 | 描述性词汇 | 禁止评价性、引导性 |
| 结构 | 无情节推进 | 禁止时序连接词     |
| 内容 | 轻意象陪伴 | 禁止具体故事情节   |

---

## 三、Prompt 工程策略

### 3.1 系统提示词（最高约束）

```
你是一个儿童晚间心理陪伴助手。你的任务是基于清醒度分桶生成
陪伴式叙述文本。

核心原则：
1. 不对话、不分析、不教育
2. 不推进情节、不使用时序连接词
3. 仅描述状态、感受、存在
4. 允许随时睡着、允许被遗忘

输出要求：
- 总字数 80-150 字
- 使用短句（5-10 字）
- 语气温和、平静
- 意象简单、无情节
```

---

### 3.2 清醒度分桶 Prompt

#### 极高清醒度 (0.8-1.0)

```
清醒度：极高

特征：
- 孩子可能还很兴奋
- 需要更多重复性包裹语言
- 可以引入身体放松引导

要求：
- 更多"可以放松"类句子
- 更多重复性词语
- 语速较慢（通过停顿实现）
- 意象相对具体

示例开头：
"今天可能很累了。身体可以慢慢放松。"
```

---

#### 中等清醒度 (0.3-0.6)

```
清醒度：中等

特征：
- 标准的陪伴状态
- 意象适中、语言稀疏

要求：
- 标准的轻意象陪伴
- 语言相对稀疏
- 有留白
- 不显式引导身体放松

示例开头：
"一天慢慢过去了。房间很安静。"
```

---

#### 极低清醒度 (0.0-0.1)

```
清醒度：极低

特征：
- 孩子几乎快要睡着了
- 意象应减少、更抽象

要求：
- 意象最少、最空
- 语言最稀疏
- 允许"无意义"的重复
- 可以仅"很安静"重复

示例开头：
"夜晚到了。一切都很安静。"
```

---

### 3.3 Magic Note 融入 Prompt

```
Magic Note: {note}

融入规则：
1. 仅提及 1-2 次，最多不超过 3 次
2. 不展开新的叙述结构
3. 提及后迅速回归通用陪伴语境
4. 不评价、不追问、不保证出现

错误示例：
"今天你捡到了一片红色的叶子。那片叶子可能是在公园里捡的。
红色代表秋天。你喜欢那片叶子吗？"

正确示例：
"窗户外面的叶子很安静。今天也有一片叶子。
红色的，安静的。就像现在一样。"
```

---

## 四、输出验证机制

### 4.1 自动验证规则

生成后必须通过以下验证：

```javascript
function validateNarrative(text) {
  const rules = [
    // 禁止疑问句
    noQuestionMarks(text),

    // 禁止评价性词汇
    noJudgmentalWords(text),

    // 禁止时序连接词
    noSequentialConnectors(text),

    // 禁止"应该""必须"
    noImperativeWords(text),

    // 字数限制
    wordCountWithin(text, 80, 150),

    // 句子长度
    sentenceLengthWithin(text, 5, 15),
  ];

  return rules.every((rule) => rule.pass);
}
```

---

### 4.2 验证失败处理

```
生成内容 → 自动验证
               ↓
          通过 → 内容安全检查 → TTS 合成
               ↓
          失败 → 记录失败原因 → 使用兜底文本
```

---

## 五、兜底文本策略

### 5.1 兜底触发条件

- LLM 超时（≥5 秒）
- 自动验证失败
- 内容安全拦截
- LLM 服务异常

---

### 5.2 兜底文本来源

**优先级**:

1. 对应清醒度分桶的预置文本
2. 相邻清醒度分桶的预置文本
3. 通用兜底文本

---

### 5.3 预置文本维护

- 每个清醒度分桶至少 3-5 条预置文本
- 预置文本由人工编写，符合《叙述内容规则》
- 预置文本需人工审核通过
- 定期更新（每月）

---

## 六、内容安全策略

### 6.1 内容安全检查

**检查时机**: LLM 生成后，TTS 合成前

**检查维度**:

- 敏感词过滤
- 暴力/恐怖内容检测
- 不当内容检测
- 政治敏感内容检测

---

### 6.2 内容安全 API

**服务商**: 阿里云内容安全 / 腾讯云天御

**检查方式**:

- 同步检查：整段文本检查
- 流式检查：分段实时检查

**拦截处理**:

- 拦截 → 记录原因 → 使用兜底文本
- 不向用户展示拦截详情

---

## 七、AI 服务配置

### 语言模型

**主模型**: 智谱 glm4-flash

---

## 八、Prompt 版本管理

### 8.1 版本策略

```
prompt/
├── v1.0/
│   ├── system.txt
│   ├── arousal_very_high.txt
│   ├── arousal_high.txt
│   ├── arousal_medium.txt
│   ├── arousal_low.txt
│   ├── arousal_very_low.txt
│   └── magic_note.txt
└── v1.1/ (未来版本)
```

---

### 8.2 版本发布流程

1. 在新版本目录编写 Prompt
2. 内部测试验证
3. 灰度发布（10% 流量）
4. 监控生成质量
5. 全量发布

---

## 九、监控与优化

### 9.1 核心监控指标

| 指标           | 说明             | 告警阈值 |
| -------------- | ---------------- | -------- |
| 生成成功率     | 成功生成比例     | < 95%    |
| 兜底触发率     | 兜底文本使用比例 | > 10%    |
| 内容安全拦截率 | 拦截比例         | > 5%     |
| 平均生成时长   | 从请求到返回     | > 3s     |
| 验证失败率     | 自动验证失败比例 | > 5%     |

---

### 9.2 质量评估

**人工抽检**:

- 每日随机抽检 100 条生成内容
- 人工审核是否符合《叙述内容规则》
- 记录问题并优化 Prompt

**用户反馈**:

- 收集用户对叙述内容的反馈
- 分析负反馈原因
- 迭代优化 Prompt

---

## 十、紧急停止机制

### 10.1 停止条件

出现以下情况，立即停止 AI 生成：

- 连续 10 次生成内容违规
- 兜底触发率 > 50%
- 内容安全拦截率 > 30%
- 用户投诉率 > 5%

---

### 10.2 停止流程

```
触发停止条件
       ↓
关闭 AI 生成开关
       ↓
切换至全预置文本模式
       ↓
发送告警通知
       ↓
问题排查与修复
       ↓
修复后重新开启
```

---

## 十一、AI 边界自查清单

在使用 AI 生成陪伴叙述前，请确认：

### 11.1 输入检查

- [ ] 清醒度在 0.0-1.0 范围内
- [ ] Magic Note 不超过 20 字
- [ ] 无其他额外变量输入

### 11.2 输出检查

- [ ] 无疑问句
- [ ] 无评价性词汇
- [ ] 无时序连接词
- [ ] 无教育隐喻
- [ ] 字数在 80-150 字
- [ ] 通过内容安全检查

### 11.3 兜底检查

- [ ] 兜底文本已准备
- [ ] 兜底触发条件已定义
- [ ] 备用模型已配置

---

## 十二、常见问题

### Q1: AI 为什么不能生成"故事"？

**A**: Moon Pal 的核心是"陪伴"而非"娱乐"。故事会唤醒孩子的注意力，违背"帮助孩子离开清醒状态"的目标。

---

### Q2: 为什么 Magic Note 不一定会被提及？

**A**: Magic Note 仅作为"软参考"，不保证出现。过度强调会破坏"陪伴"的纯粹性，变成"对话"。

---

### Q3: 为什么 AI 生成需要这么多限制？

**A**: 儿童睡前心理非常敏感。任何不当的引导、分析、教育都可能影响睡眠质量。必须确保生成的每一句话都是安全的。

---

### Q4: 如果 AI 生成的内容不好怎么办？

**A**: 我们有完整的兜底机制。如果 AI 生成失败或不符合规则，系统会自动切换到人工编写的预置文本，确保体验不中断。

---

_本文档版本: v1.0_
_最后更新: 2026-01-07_
